<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Scheduling Platform</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #475569;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }

        * {
            box-sizing: border-box;
        }

        header {
            background: var(--surface);
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            header {
                margin-bottom: 2rem;
            }
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        @media (min-width: 1024px) {
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary);
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0;
            width: 100%;
        }

        @media (min-width: 1024px) {
            .controls {
                width: auto;
                gap: 1rem;
                flex-wrap: nowrap;
            }
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            button {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
        }

        button:hover {
            opacity: 0.9;
        }

        button.secondary {
            background: var(--surface);
            color: var(--secondary);
            border: 1px solid var(--border);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .tabs {
                gap: 1rem;
                flex-wrap: wrap;
            }
        }

        .tab-btn {
            background: transparent;
            color: var(--secondary);
            border: none;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .stat-card {
            background: var(--surface);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 1.5rem;
            }
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        @media (min-width: 768px) {
            .stat-value {
                font-size: 2rem;
            }
        }

        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        /* Live Queue Rows */
        .lq-row {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lq-row:last-child {
            border-bottom: none;
        }

        .lq-current {
            background: #f0fdf4;
        }

        .lq-previous {
            background: #f8fafc;
            /* Dimmed background */
            opacity: 0.85;
        }

        .lq-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            width: 80px;
            text-align: center;
        }

        .badge-previous {
            background: #e2e8f0;
            color: #64748b;
        }

        .now {
            background: #16a34a;
            color: white;
        }

        .next {
            background: #3b82f6;
            color: white;
        }

        .after {
            background: #94a3b8;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            th,
            td {
                padding: 1rem;
                font-size: 1rem;
            }
        }

        th {
            background: #f1f5f9;
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-scheduled {
            background: #dcfce7;
            color: #166534;
        }

        .badge-conflict {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-inprogress {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-completed {
            background: #f1f5f9;
            color: #475569;
            text-decoration: line-through;
        }

        .badge-cancelled {
            background: #fef2f2;
            color: #991b1b;
        }

        .btn-action-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.3rem;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            border: none;
            cursor: pointer;
        }

        .btn-complete {
            background: #16a34a;
            color: white;
        }

        .btn-cancel {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .btn-inprogress {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        #loading {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #fef08a;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: none;
        }

        /* Admin Panel */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.25rem;
        }

        .admin-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .admin-card h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--primary);
        }

        .admin-card small {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .walkin-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .walkin-open {
            background: #dcfce7;
            color: #166534;
        }

        .walkin-closed {
            background: #fee2e2;
            color: #991b1b;
        }

        .admin-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem 1rem;
            font-size: 0.85rem;
            color: #475569;
        }

        .admin-meta span {
            font-weight: 600;
            color: #1e293b;
        }

        .positions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .pos-badge {
            background: #eff6ff;
            color: #1d4ed8;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 500;
        }

        .admin-card-footer {
            display: flex;
            justify-content: flex-end;
        }

        /* Make admin cards clickable */
        .admin-card {
            cursor: pointer;
            transition: box-shadow 0.15s, transform 0.1s;
        }

        .admin-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* ‚îÄ‚îÄ‚îÄ Live Queue View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #view-livequeue {
            display: none;
        }

        .lq-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .lq-header h2 {
            margin: 0;
            font-size: 1.15rem;
        }

        .lq-refresh-info {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .lq-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.25rem;
        }

        .lq-company-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.85rem;
            overflow: hidden;
        }

        .lq-company-header {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .lq-panel-block {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .lq-panel-block:last-child {
            border-bottom: none;
        }

        .lq-panel-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .lq-row {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0.6rem;
            border-radius: 0.5rem;
            margin-bottom: 0.35rem;
            border-left: 4px solid transparent;
        }

        .lq-row.lq-current {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }

        .lq-row.lq-next1 {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }

        .lq-row.lq-next2 {
            background: #f8fafc;
            border-left-color: #94a3b8;
        }

        .lq-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.45rem;
            border-radius: 0.3rem;
            white-space: nowrap;
            min-width: 52px;
            text-align: center;
        }

        .lq-badge.now {
            background: #dcfce7;
            color: #15803d;
        }

        .lq-badge.next {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .lq-badge.after {
            background: #e2e8f0;
            color: #475569;
        }

        .lq-student-name {
            font-weight: 600;
            font-size: 0.88rem;
            line-height: 1.2;
        }

        .lq-student-reg {
            font-size: 0.78rem;
            color: var(--secondary);
            font-family: monospace;
        }

        .lq-time {
            font-size: 0.75rem;
            color: var(--secondary);
            margin-top: 0.1rem;
        }

        .lq-empty {
            font-size: 0.82rem;
            color: #94a3b8;
            font-style: italic;
            padding: 0.3rem 0;
        }

        /* Company Detail View */
        #view-company-detail {
            display: none;
        }

        .detail-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .detail-back-btn:hover {
            text-decoration: underline;
        }

        .detail-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .detail-section h3 {
            margin: 0 0 1rem 0;
            font-size: 0.95rem;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .settings-row label {
            font-size: 0.85rem;
            color: #475569;
            min-width: 130px;
            font-weight: 500;
        }

        .settings-row input[type="time"],
        .settings-row input[type="number"] {
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 0.4rem;
            font-size: 0.85rem;
            width: 110px;
        }

        /* Panel cards */
        .panel-card {
            border: 1px solid var(--border);
            border-radius: 0.6rem;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .panel-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #f8fafc;
            cursor: pointer;
            user-select: none;
        }

        .panel-card-header:hover {
            background: #f1f5f9;
        }

        .panel-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e293b;
        }

        .panel-card-meta {
            font-size: 0.78rem;
            color: #64748b;
            margin-top: 0.15rem;
        }

        .panel-card-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Inline panel editor */
        .panel-editor {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: #fff;
            display: none;
        }

        .panel-editor.open {
            display: block;
        }

        .editor-row {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.85rem;
            flex-wrap: wrap;
        }

        .editor-row label {
            font-size: 0.83rem;
            color: #475569;
            min-width: 150px;
            padding-top: 0.2rem;
            font-weight: 500;
        }

        .editor-row input[type="text"],
        .editor-row input[type="number"] {
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 0.4rem;
            font-size: 0.85rem;
        }

        .role-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .role-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: #f1f5f9;
            border-radius: 0.4rem;
            padding: 0.25rem 0.6rem;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .role-checkbox-item input {
            cursor: pointer;
        }

        .role-checkbox-item:has(input:checked) {
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 600;
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }

        /* Toast notification */
        #toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #1e293b;
            color: white;
            padding: 0.65rem 1.1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s;
            z-index: 9999;
        }

        #toast.show {
            opacity: 1;
        }

        /* Master Dashboard CSS */
        .timeline-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--surface);
        }

        .timeline-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .timeline-table th,
        .timeline-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            background: var(--surface);
            z-index: 10;
            border-right: 1px solid var(--border);
            width: 220px;
            min-width: 220px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding-right: 1rem;
        }

        .timeline-scroll-area {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            min-height: 50px;
        }

        .t-card {
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            padding: 0.4rem 0.6rem;
            border-radius: 0.4rem;
            min-width: 130px;
            font-size: 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: transform 0.1s;
        }

        .t-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .t-past {
            background: #f8fafc;
            color: #94a3b8;
        }

        .t-current {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
            box-shadow: 0 0 0 1px #86efac;
        }

        .t-upcoming {
            background: #eff6ff;
            color: #1e3a8a;
        }

        .t-cancelled {
            background: #fef2f2;
            color: #991b1b;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .search-bar {
            width: 100%;
            padding: 0.6rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.4rem;
            font-size: 0.9rem;
        }
    </style>
</head>


<body>
    <div id="loading">Loading...</div>

    <header>
        <div class="container header-content">
            <h1>üìÖ Interview Scheduler</h1>
            <div class="controls">
                <button style="background:#16a34a; color:white; border:none;display:none;" onclick="importResponses()">üìÇ Load Data
                    from CSV</button>
                <div style="display:flex; align-items:center; gap:0.4rem;">
                    <input type="date" id="event-date-input"
                        style="padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.4rem; font-size:0.85rem;display: none;"
                        title="Event date for scheduling" />
                    <button style="display:none;" onclick="runSchedule()">‚ñ∂ Run Auto-Schedule</button>
                </div>
                <div style="border-left: 1px solid #ccc; padding-left: 1rem; display:flex; gap:0.5rem;">
                    <button style="display:none;"class="secondary" onclick="downloadCSV('companies')">üì• Export Companies</button>
                    <button style="display:none;" class="secondary" onclick="downloadCSV('students')">üì• Export Students</button>
                </div>
                <button style="display:none;"secondary" onclick="resetData()">Reset Data</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="count-students">-</div>
                <div class="stat-label">Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="count-companies">-</div>
                <div class="stat-label">Companies</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="count-interviews">-</div>
                <div class="stat-label">Interviews Scheduled</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('companies')">Company Schedules</button>
            <button class="tab-btn" onclick="switchTab('students')">Student Schedules</button>
            <button class="tab-btn" onclick="switchTab('master-students')">üéì Student Timeline</button>
            <button class="tab-btn" onclick="switchTab('master-companies')">üè¢ Company Timeline</button>
            <button class="tab-btn" onclick="switchTab('admin')">üõ† Admin Panel</button>
            <button class="tab-btn" onclick="switchTab('statistics')">üìä Statistics</button>
            <button class="tab-btn" onclick="switchTab('livequeue')">üéØ Live Queue</button>
        </div>

        <div id="view-companies" class="view-panel">
            <div class="table-container">
                <table id="companies-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Total Slots</th>
                            <th>Schedule Preview</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="view-students" class="view-panel" style="display:none;">
            <div class="table-container">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Detail View Panel -->
        <div id="view-detail" class="view-panel" style="display:none;">
            <div style="margin-bottom: 1rem;">
                <button class="secondary" onclick="closeDetail()">‚Üê Back to Dashboard</button>
            </div>
            <div class="stat-card" style="text-align: left; margin-bottom: 1rem;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2 id="detail-title" style="margin:0; color:var(--primary);">Name</h2>
                        <p id="detail-subtitle" style="margin:0; color:var(--secondary);">ID</p>
                    </div>
                    <button id="detail-export-btn" class="secondary">‚¨á Export CSV</button>
                </div>
            </div>

            <div class="table-container">
                <table id="detail-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>With</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Admin Panel View -->
        <div id="view-admin" class="view-panel" style="display:none;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap; gap:0.5rem;">
                <h2 style="margin:0; font-size:1.1rem; color:var(--secondary);">Company Overview &amp; Walk-in
                    Management</h2>
                <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
                    <span id="admin-refresh-countdown" style="font-size:0.78rem; color:#94a3b8;"></span>
                    <button class="secondary" onclick="loadAdminSummary()"
                        style="font-size:0.8rem; padding:0.4rem 0.8rem;">üîÑ Refresh</button>
                </div>
            </div>
            <!-- Backup / Restore bar -->
            <div
                style="display:flex; align-items:center; gap:0.6rem; margin-bottom:1rem; padding:0.6rem 0.9rem; background:#f8fafc; border:1px solid var(--border); border-radius:0.6rem; flex-wrap:wrap;">
                <span style="font-size:0.8rem; font-weight:600; color:var(--secondary);">Data Safety:</span>
                <button onclick="doCheckpoint()"
                    style="font-size:0.8rem; padding:0.35rem 0.8rem; background:#16a34a; color:white; border:none; border-radius:0.4rem; cursor:pointer;">üíæ
                    Checkpoint</button>
                <button onclick="doRestore()"
                    style="font-size:0.8rem; padding:0.35rem 0.8rem; background:#ea580c; color:white; border:none; border-radius:0.4rem; cursor:pointer;">‚Ü©
                    Restore from Backup</button>
                <span id="checkpoint-label" style="font-size:0.75rem; color:#94a3b8; margin-left:0.25rem;"></span>
            </div>
            <!-- New Company Defaults card -->
            <details id="company-defaults-panel" style="margin-bottom:1rem; border:1px solid var(--border); border-radius:0.6rem; background:#f8fafc;">
                <summary style="padding:0.6rem 0.9rem; font-size:0.85rem; font-weight:600; cursor:pointer; color:var(--secondary); list-style:none; display:flex; align-items:center; gap:0.5rem;">
                    ‚öô New Company Defaults
                    <span style="font-size:0.75rem; font-weight:400; color:#94a3b8;">‚Äî applied when a company first appears in a CSV import</span>
                </summary>
                <div style="padding:0.75rem 1rem 1rem; display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end;">
                    <div style="display:flex; flex-direction:column; gap:0.3rem;">
                        <label style="font-size:0.78rem; color:var(--secondary); font-weight:600;">Interview Window</label>
                        <div style="display:flex; align-items:center; gap:0.4rem;">
                            <input type="time" id="def-avail-start" value="09:00" style="width:110px;" />
                            <span style="font-size:0.8rem; color:#94a3b8;">to</span>
                            <input type="time" id="def-avail-end" value="17:00" style="width:110px;" />
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.3rem;">
                        <label style="font-size:0.78rem; color:var(--secondary); font-weight:600;">Default Break</label>
                        <div style="display:flex; align-items:center; gap:0.4rem;">
                            <input type="time" id="def-break-start" style="width:110px;" title="Leave empty for no break" />
                            <span style="font-size:0.8rem; color:#94a3b8;">to</span>
                            <input type="time" id="def-break-end" style="width:110px;" title="Leave empty for no break" />
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.3rem;">
                        <label style="font-size:0.78rem; color:var(--secondary); font-weight:600;">Default Panel Label</label>
                        <input type="text" id="def-panel-label" value="Panel 1 (Default)" style="width:180px;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.3rem;">
                        <label style="font-size:0.78rem; color:var(--secondary); font-weight:600;">Slot Duration (min)</label>
                        <input type="number" id="def-slot-duration" value="30" min="10" max="120" step="5" style="width:80px;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.3rem;">
                        <label style="font-size:0.78rem; color:var(--secondary); font-weight:600;">Reserved Walk-in Slots</label>
                        <input type="number" id="def-reserved" value="0" min="0" max="16" style="width:80px;" />
                    </div>
                    <button onclick="saveCompanyDefaults()" style="font-size:0.82rem; padding:0.4rem 0.9rem; background:#0f172a; color:white; border:none; border-radius:0.4rem; cursor:pointer; align-self:flex-end;">üíæ Save Defaults</button>
                </div>
            </details>

            <!-- Grid view (default) -->
            <div id="admin-grid" class="admin-grid"></div>

            <!-- Company detail view (shown when a card is clicked) -->
            <div id="view-company-detail">
                <button class="detail-back-btn" onclick="closeCompanyDetail()">‚Üê Back to Admin Panel</button>
                <h2 id="detail-company-name" style="margin:0 0 1.25rem 0; font-size:1.3rem; color:var(--primary);"></h2>

                <!-- Company Settings Section -->
                <div class="detail-section">
                    <h3>‚öô Company Settings</h3>
                    <div class="settings-row">
                        <label>Interview Window</label>
                        <input type="time" id="detail-avail-start" value="09:00" />
                        <span style="color:#64748b; font-size:0.85rem;">to</span>
                        <input type="time" id="detail-avail-end" value="17:00" />
                    </div>
                    <div class="settings-row" style="margin-top:0.5rem;">
                        <label title="Leave empty for no company-wide break. Configure per-panel if panels need different break times.">Company Break</label>
                        <input type="time" id="detail-break-start" title="Break start (leave empty for none)" />
                        <span style="color:#64748b; font-size:0.85rem;">to</span>
                        <input type="time" id="detail-break-end" title="Break end (leave empty for none)" />
                        <button onclick="saveCompanySettings()" style="font-size:0.82rem; padding:0.35rem 0.8rem;">üíæ Save</button>
                    </div>
                </div>

                <!-- Panels Section -->
                <div class="detail-section">
                    <h3>üóÇ Interview Panels</h3>
                    <div id="panels-list"></div>
                    <button onclick="addPanel()"
                        style="margin-top:0.5rem; font-size:0.85rem; padding:0.4rem 0.9rem; background:#16a34a; color:white; border:none; border-radius:0.4rem; cursor:pointer;">
                        + Add Panel
                    </button>
                </div>
            </div>
        </div>
        <!-- Master Student Timeline View -->
        <div id="view-master-students" class="view-panel" style="display:none;">
            <input type="text" id="student-search" class="search-bar" placeholder="üîç Search students by Name or ID..."
                onkeyup="renderMasterStudents()">
            <div class="timeline-container">
                <table class="timeline-table">
                    <thead>
                        <tr>
                            <th class="sticky-col">Student</th>
                            <th>Interview Timeline</th>
                        </tr>
                    </thead>
                    <tbody id="master-students-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Master Company Timeline View -->
        <div id="view-master-companies" class="view-panel" style="display:none;">
            <input type="text" id="company-search" class="search-bar" placeholder="üîç Search companies..."
                onkeyup="renderMasterCompanies()">
            <div class="timeline-container">
                <table class="timeline-table">
                    <thead>
                        <tr>
                            <th class="sticky-col">Company / Panel</th>
                            <th>Interview Timeline</th>
                        </tr>
                    </thead>
                    <tbody id="master-companies-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Statistics View -->
        <div id="view-statistics" class="view-panel" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="margin:0; font-size:1.1rem; color:var(--secondary);">üìä Event Statistics</h2>
                <button class="secondary" onclick="loadStatistics()" style="font-size:0.8rem; padding:0.4rem 0.8rem;">üîÑ Refresh</button>
            </div>

            <!-- KPI cards row -->
            <div id="stats-cards" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:0.75rem; margin-bottom:1.75rem;"></div>

            <!-- Walk-in candidates section -->
            <details id="stats-walkin-panel" style="margin-bottom:1.25rem; border:1px solid var(--border); border-radius:0.6rem; background:#f8fafc;">
                <summary style="padding:0.6rem 0.9rem; font-size:0.85rem; font-weight:600; cursor:pointer; color:var(--secondary); list-style:none; display:flex; align-items:center; gap:0.5rem;">
                    üö∂ Walk-in Candidates
                    <span style="font-size:0.75rem; font-weight:400; color:#94a3b8;">‚Äî students with no shortlisted applications</span>
                </summary>
                <div style="padding:0.5rem 1rem 1rem;">
                    <div class="table-container">
                        <table id="stats-walkin-table">
                            <thead><tr><th>Student</th><th>ID</th><th>Email</th><th style="text-align:center;">Applications Submitted</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <!-- Per-company shortlist breakdown -->
            <h3 style="font-size:0.95rem; color:var(--secondary); margin:0 0 0.5rem 0;">Shortlist Breakdown by Company</h3>
            <div class="table-container">
                <table id="stats-company-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th style="text-align:center;">Shortlisted</th>
                            <th style="text-align:center;">Applied (not shortlisted)</th>
                            <th style="text-align:center;">Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Live Queue View -->
        <div id="view-livequeue" class="view-panel" style="display:none;">
            <div class="lq-header">
                <h2>üéØ Live Interview Queue</h2>
                <span class="lq-refresh-info" id="lq-refresh-countdown"></span>
            </div>
            <div id="lq-grid" class="lq-grid"></div>
        </div>

    </div>

    <div id="toast"></div>


    <script>
        let companies_data = [];
        let students_data = [];
        let schedule_data = [];
        let admin_data = [];

        async function init() {
            await loadData();
        }

        function downloadCSV(type, id) {
            let url = `/api/export/${type}`;
            if (id) url += `/${id}`;
            window.location.href = url;
        }

        async function loadData() {
            showLoading(true);
            try {
                const [cRes, sRes, schRes] = await Promise.all([
                    fetch('../schedule_manager/data/companies.json'),
                    fetch('../schedule_manager/data/students.json'),
                    fetch('../schedule_manager/data/schedule.json')
                ]);

                companies_data = await cRes.json();
                students_data = await sRes.json();
                schedule_data = await schRes.json();

                updateStats();
                renderCompanyView();
                renderStudentView();

                // Load admin summary in background
                loadAdminSummary();
            } catch (e) {
                console.error(e);
                alert("Failed to load backup data");
            } finally {
                showLoading(false);
            }
        }

        // --- Navigation ---

        function showDetail(type, id) {
            // Hide all panels
            document.querySelectorAll('.view-panel').forEach(p => p.style.display = 'none');
            // Hide tabs
            document.querySelector('.tabs').style.display = 'none';
            // Show detail panel
            document.getElementById('view-detail').style.display = 'block';

            const titleEl = document.getElementById('detail-title');
            const subEl = document.getElementById('detail-subtitle');
            const tbody = document.querySelector('#detail-table tbody');
            const exportBtn = document.getElementById('detail-export-btn');

            tbody.innerHTML = '';

            let entityName = "";
            let interviews = [];

            if (type === 'company') {
                const c = companies_data.find(x => x.id === id);
                entityName = c.name;
                titleEl.textContent = c.name;
                subEl.textContent = `Company ID: ${c.id}`;
                exportBtn.onclick = () => downloadCSV('company', id);

                // Get interviews
                interviews = schedule_data.filter(i => i.company_id === id);

                interviews.sort((a, b) => a.start_time.localeCompare(b.start_time));

                interviews.forEach(i => {
                    const s = students_data.find(x => x.id === i.student_id);
                    const time = i.start_time.split('T')[1].slice(0, 5);
                    const roleTitle = getRoleTitle(i.company_id, i.job_role_id);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="badge badge-scheduled">${time}</span></td>
                        <td><strong>${s ? s.name : i.student_id}</strong> <small>(${i.student_id})</small></td>
                        <td>${roleTitle}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } else if (type === 'student') {
                const s = students_data.find(x => x.id === id);
                entityName = s.name;
                titleEl.textContent = s.name;
                subEl.textContent = `Student ID: ${s.id} | ${s.email}`;
                exportBtn.onclick = () => downloadCSV('student', id);

                interviews = schedule_data.filter(i => i.student_id === id);
                interviews.sort((a, b) => a.start_time.localeCompare(b.start_time));

                interviews.forEach(i => {
                    const c = companies_data.find(x => x.id === i.company_id);
                    const time = i.start_time.split('T')[1].slice(0, 5);
                    const roleTitle = getRoleTitle(i.company_id, i.job_role_id);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="badge badge-scheduled">${time}</span></td>
                        <td><strong>${c ? c.name : i.company_id}</strong></td>
                        <td>${roleTitle}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            if (interviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">No interviews scheduled.</td></tr>';
            }
        }

        function closeDetail() {
            document.getElementById('view-detail').style.display = 'none';
            document.querySelector('.tabs').style.display = 'flex';
            // Determine which tab to show based on active button
            const activeTab = document.querySelector('.tab-btn.active').textContent.includes('Company') ? 'companies' : 'students';
            document.getElementById(`view-${activeTab}`).style.display = 'block';
        }

        // Set default event date to today
        (function () {
            const input = document.getElementById('event-date-input');
            if (input) input.value = new Date().toISOString().split('T')[0];
        })();

        // Auto-refresh timer for Admin Panel
        let adminRefreshTimer = null;
        let adminCountdown = 0;
        const ADMIN_REFRESH_INTERVAL = 30; // seconds

        function startAdminAutoRefresh() {
            stopAdminAutoRefresh();
            adminCountdown = ADMIN_REFRESH_INTERVAL;
            updateCountdownLabel();
            adminRefreshTimer = setInterval(() => {
                adminCountdown--;
                updateCountdownLabel();
                if (adminCountdown <= 0) {
                    loadAdminSummary();
                    adminCountdown = ADMIN_REFRESH_INTERVAL;
                }
            }, 1000);
        }

        function stopAdminAutoRefresh() {
            if (adminRefreshTimer) { clearInterval(adminRefreshTimer); adminRefreshTimer = null; }
            const lbl = document.getElementById('admin-refresh-countdown');
            if (lbl) lbl.textContent = '';
        }

        // --- Live Queue ---
        let lqRefreshTimer = null;
        let lqCountdown = 0;
        const LQ_REFRESH_INTERVAL = 30;

        function startLiveQueueRefresh() {
            stopLiveQueueRefresh();
            loadLiveQueue();
            lqCountdown = LQ_REFRESH_INTERVAL;
            lqRefreshTimer = setInterval(() => {
                lqCountdown--;
                const lbl = document.getElementById('lq-refresh-countdown');
                if (lbl) lbl.textContent = `Auto-refresh in ${lqCountdown}s`;
                if (lqCountdown <= 0) {
                    loadLiveQueue();
                    lqCountdown = LQ_REFRESH_INTERVAL;
                }
            }, 1000);
        }

        function stopLiveQueueRefresh() {
            if (lqRefreshTimer) { clearInterval(lqRefreshTimer); lqRefreshTimer = null; }
            const lbl = document.getElementById('lq-refresh-countdown');
            if (lbl) lbl.textContent = '';
        }

        async function loadLiveQueue() {
            try {
                const res = await fetch('/api/live-queue');
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                renderLiveQueue(data);
            } catch (e) {
                console.error('Live queue load failed', e);
            }
        }

        async function markComplete(id) {
            if (!confirm("Mark this interview as complete?")) return;
            try {
                await fetch(`/api/interview/${id}/complete`, { method: 'POST' });
                loadLiveQueue(); // Refresh immediately
            } catch (e) { alert("Action failed"); }
        }

        async function cancelInterview(id) {
            if (!confirm("Cancel this interview? Slot will arguably remain empty.")) return;
            try {
                await fetch(`/api/interview/${id}/cancel`, { method: 'POST' });
                loadLiveQueue(); // Refresh immediately
            } catch (e) { alert("Action failed"); }
        }

        async function markInProgress(id) {  // Bug #4 fix: was missing
            try {
                await fetch(`/api/interview/${id}/in-progress`, { method: 'POST' });
                loadLiveQueue(); // Refresh immediately
            } catch (e) { alert("Action failed"); }
        }

        // --- Master Dashboards (Phase 4) ---

        function getStatusClass(iv) {
            const status = iv.status || 'scheduled';
            if (status === 'cancelled') return 't-cancelled';
            if (status === 'completed') return 't-past';
            if (status === 'in_progress') return 't-current';

            // Time-based fallback for 'scheduled'
            const now = new Date(); // Use local system time of browser
            // Actually, we should parse iv.start/end strings.
            try {
                // ISO strings: 2026-02-19T09:00:00
                const start = new Date(iv.start_time);
                const end = new Date(iv.end_time);
                if (status === 'scheduled') {
                    if (end <= now) return 't-past';
                    if (start <= now && now < end) return 't-current';
                    return 't-upcoming';
                }
            } catch (e) { }
            return 't-upcoming';
        }

        function renderMasterStudents() {
            const filter = document.getElementById('student-search').value.toLowerCase();
            const tbody = document.getElementById('master-students-tbody');
            tbody.innerHTML = '';

            students_data.forEach(s => {
                if (filter && !s.name.toLowerCase().includes(filter) && !s.id.toLowerCase().includes(filter)) return;

                const ivs = schedule_data.filter(i => i.student_id === s.id)
                    .sort((a, b) => a.start_time.localeCompare(b.start_time));

                if (ivs.length === 0 && filter) return; // Skip empty if searching? Maybe show empty too.

                const tr = document.createElement('tr');

                // Timeline cards
                const cardsHtml = ivs.map(iv => {
                    const company = companies_data.find(c => c.id === iv.company_id);
                    const cName = company ? company.name.substring(0, 18) + (company.name.length > 18 ? '‚Ä¶' : '') : iv.company_id;
                    const timeStart = iv.start_time.split('T')[1].slice(0, 5);
                    const timeEnd = iv.end_time.split('T')[1].slice(0, 5);
                    const cls = getStatusClass(iv);
                    const roleTitle = getRoleTitle(iv.company_id, iv.job_role_id);
                    const statusLabel = (iv.status && iv.status !== 'scheduled') ? iv.status.replace('_', ' ') : '';
                    const title = `${cName}\n${timeStart}‚Äì${timeEnd}\n${roleTitle}\n${iv.status}`;

                    return `<div class="t-card ${cls}" title="${title}">
                        <div style="font-weight:bold; font-size:0.78rem;">${timeStart}‚Äì${timeEnd}</div>
                        <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px;">${cName}</div>
                        <div style="font-size:0.7rem; opacity:0.8;">${roleTitle}</div>
                        ${statusLabel ? `<div style="font-size:0.65rem; font-weight:700; text-transform:uppercase; margin-top:2px;">${statusLabel}</div>` : ''}
                    </div>`;
                }).join('');

                tr.innerHTML = `
                    <td class="sticky-col">
                        <div style="font-weight:600;">${s.name}</div>
                        <div style="font-size:0.8rem; color:var(--secondary);">${s.id}</div>
                    </td>
                    <td>
                        <div class="timeline-scroll-area">
                            ${cardsHtml || '<span style="color:#ccc; font-size:0.8rem;">No interviews</span>'}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderMasterCompanies() {
            const filter = document.getElementById('company-search').value.toLowerCase();
            const tbody = document.getElementById('master-companies-tbody');
            tbody.innerHTML = '';

            companies_data.forEach(c => {
                if (filter && !c.name.toLowerCase().includes(filter)) return;

                // Render each panel as a row
                // Fallback uses the real panel_id pattern the scheduler assigns ({id}-P0)
                const panels = (c.panels && c.panels.length > 0) ? c.panels : [{ panel_id: `${c.id}-P0`, label: 'Main Panel' }];

                panels.forEach((p, idx) => {
                    const tr = document.createElement('tr');

                    // Filter interviews for this company AND panel
                    const ivs = schedule_data.filter(i =>
                        i.company_id === c.id &&
                        (i.panel_id === p.panel_id ||
                         !i.panel_id ||
                         (p.panel_id === `${c.id}-P0` && !i.panel_id))
                    ).sort((a, b) => a.start_time.localeCompare(b.start_time));

                    const cardsHtml = ivs.map(iv => {
                        const student = students_data.find(s => s.id === iv.student_id);
                        const sName = student ? student.name : iv.student_id;
                        const timeStart = iv.start_time.split('T')[1].slice(0, 5);
                        const timeEnd = iv.end_time.split('T')[1].slice(0, 5);
                        const cls = getStatusClass(iv);
                        const roleTitle = getRoleTitle(iv.company_id, iv.job_role_id);
                        const statusLabel = (iv.status && iv.status !== 'scheduled') ? iv.status.replace('_', ' ') : '';
                        const tooltip = `${sName} (${iv.student_id})\n${timeStart}‚Äì${timeEnd}\n${roleTitle}\n${iv.status}`;

                        return `<div class="t-card ${cls}" title="${tooltip}">
                            <div style="font-weight:bold; font-size:0.78rem;">${timeStart}‚Äì${timeEnd}</div>
                            <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px;">${sName}</div>
                            <div style="font-size:0.7rem; opacity:0.8;">${roleTitle}</div>
                            ${statusLabel ? `<div style="font-size:0.65rem; font-weight:700; text-transform:uppercase; margin-top:2px;">${statusLabel}</div>` : ''}
                        </div>`;
                    }).join('');

                    tr.innerHTML = `
                        <td class="sticky-col">
                            <div style="font-weight:600;">${c.name}</div>
                            <div style="font-size:0.8rem; color:var(--secondary);">${p.label || ('Panel ' + (idx + 1))}</div>
                        </td>
                        <td>
                            <div class="timeline-scroll-area">
                                ${cardsHtml || '<span style="color:#ccc; font-size:0.8rem;">No interviews</span>'}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function renderLiveQueue(data) {
            const grid = document.getElementById('lq-grid');
            grid.innerHTML = '';

            data.forEach(company => {
                const card = document.createElement('div');
                card.className = 'lq-company-card';

                let panelsHtml = '';
                company.panels.forEach(panel => {
                    const showPanelLabel = company.panels.length > 1;

                    const makeRow = (entry, cls, badgeClass, badgeText) => {
                        if (!entry) {
                            return `<div class="lq-row ${cls}">
                                <span class="lq-badge ${badgeClass}">${badgeText}</span>
                                <span class="lq-empty">${cls === 'lq-current' ? '‚è∏ No active interview' : '‚Äî Queue empty ‚Äî'}</span>
                            </div>`;
                        }

                        // Phase 3: Status styling
                        let statusBadgeClass = badgeClass;
                        let statusText = badgeText;
                        if (entry.status === 'in_progress') { statusBadgeClass = 'badge-inprogress'; statusText = 'üîµ IN PROGRESS'; }
                        if (entry.status === 'completed') { statusBadgeClass = 'badge-completed'; statusText = 'üü¢ DONE'; }
                        if (entry.status === 'cancelled') { statusBadgeClass = 'badge-cancelled'; statusText = 'üî¥ CANCELLED'; }

                        // Show actions only for "NOW" row or "PREVIOUS" row (if not done)
                        let actions = '';
                        const actionable = (cls === 'lq-current' || cls === 'lq-previous') &&
                            entry.status !== 'completed' &&
                            entry.status !== 'cancelled';

                        if (actionable) {
                            const inProgressBtn = entry.status !== 'in_progress'
                                ? `<button class="btn-sm btn-inprogress" onclick="markInProgress('${entry.interview_id}')">üîÑ In Progress</button>`
                                : '';
                            actions = `
                                <div class="btn-action-row">
                                    <button class="btn-sm btn-complete" onclick="markComplete('${entry.interview_id}')">‚úÖ Mark Complete</button>
                                    ${inProgressBtn}
                                    <button class="btn-sm btn-cancel" onclick="cancelInterview('${entry.interview_id}')">‚ùå Cancel</button>
                                </div>
                            `;
                        }

                        return `<div class="lq-row ${cls}">
                            <span class="lq-badge ${statusBadgeClass}">${statusText}</span>
                            <div>
                                <div class="lq-student-name">${entry.student_name}</div>
                                <div class="lq-student-reg">${entry.student_id}</div>
                                <div class="lq-time">${entry.start_time}‚Äì${entry.end_time} &middot; ${entry.role}</div>
                                ${actions}
                            </div>
                        </div>`;
                    };

                    const prev = panel.previous || null;
                    const next0 = panel.next[0] || null;
                    const next1 = panel.next[1] || null;

                    panelsHtml += `<div class="lq-panel-block">
                        ${showPanelLabel ? `<div class="lq-panel-label">${panel.panel_label}</div>` : ''}
                        ${makeRow(prev, 'lq-previous', 'badge-previous', '‚ö™ PREVIOUS')}
                        ${makeRow(panel.current, 'lq-current', 'now', 'üü¢ NOW')}
                        ${makeRow(next0, 'lq-next1', 'next', 'üîµ NEXT')}
                        ${makeRow(next1, 'lq-next2', 'after', '‚ö™ AFTER')}
                    </div>`;
                });

                card.innerHTML = `
                    <div class="lq-company-header">${company.company_name}</div>
                    ${panelsHtml}
                `;
                grid.appendChild(card);
            });
        }

        function updateCountdownLabel() {
            const lbl = document.getElementById('admin-refresh-countdown');
            if (lbl) lbl.textContent = `Auto-refresh in ${adminCountdown}s`;
        }

        async function runSchedule() {
            const dateInput = document.getElementById('event-date-input');
            const eventDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
            if (!eventDate) { alert('Please select an event date first.'); return; }
            if (!confirm(`Run automatic scheduling for ${eventDate}? This will overwrite the current schedule.`)) return;
            showLoading(true);
            try {
                const res = await fetch('/api/run-schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_date: eventDate })
                });
                const data = await res.json();
                alert(data.message);
                await loadData();
            } catch (e) {
                alert("Scheduling failed");
            } finally {
                showLoading(false);
            }
        }

        async function importResponses() {
            if (!confirm("Load data from 'Carrier Fair - 2026_responses.csv'? This will overwrite current students and companies data.")) return;
            showLoading(true);
            try {
                const res = await fetch('/api/import-responses', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'error') {
                    alert("Import failed: " + data.message);
                } else {
                    alert(data.message);
                    await loadData();
                }
            } catch (e) {
                alert("Import failed: " + e);
            } finally {
                showLoading(false);
            }
        }

        async function resetData() {
            if (!confirm("Reset all data to seed defaults? This cannot be undone.")) return;
            showLoading(true);
            try {
                await fetch('/api/init', { method: 'POST' });
                await loadData();
                alert("Data reset.");
            } catch (e) {
                alert("Reset failed");
            } finally {
                showLoading(false);
            }
        }

        function updateStats() {
            document.getElementById('count-students').textContent = students_data.length;
            document.getElementById('count-companies').textContent = companies_data.length;
            document.getElementById('count-interviews').textContent = schedule_data.length;
        }

        function getRoleTitle(companyId, roleId) {
            const company = companies_data.find(c => c.id === companyId);
            if (!company || !company.job_roles) return roleId;
            const role = company.job_roles.find(r => r.id === roleId);
            return role ? role.title : roleId;
        }

        function renderCompanyView() {
            const tbody = document.querySelector('#companies-table tbody');
            tbody.innerHTML = '';

            companies_data.forEach(c => {
                // Find interviews for this company
                const interviews = schedule_data.filter(i => i.company_id === c.id)
                    .sort((a, b) => a.start_time.localeCompare(b.start_time));

                const tr = document.createElement('tr');

                // Format first 3 interviews as preview
                const preview = interviews.slice(0, 3).map(i => {
                    const time = i.start_time.split('T')[1].slice(0, 5);
                    const student = students_data.find(s => s.id === i.student_id);
                    const roleTitle = getRoleTitle(c.id, i.job_role_id);
                    return `<span class="badge badge-scheduled" title="${roleTitle}">${time}: ${student ? student.name : i.student_id} (${roleTitle})</span>`;
                }).join(' ');

                const extra = interviews.length > 3 ? ` <small>+${interviews.length - 3} more</small>` : '';

                tr.innerHTML = `
                    <td>
                        <a href="#" onclick="showDetail('company', '${c.id}'); return false;" style="font-weight:bold; color:var(--primary); text-decoration:none;">${c.name}</a>
                        <br><small style="color:#666">${c.id}</small>
                    </td>
                    <td>${interviews.length}</td>
                    <td>${preview}${extra}</td>
                    <td><button style="padding:0.25rem 0.5rem; font-size:0.8rem; display:none;" class="secondary" onclick="downloadCSV('company', '${c.id}')">‚¨á CSV</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderStudentView() {
            const tbody = document.querySelector('#students-table tbody');
            tbody.innerHTML = '';

            // Render first 50 to avoid lag if too many
            students_data.slice(0, 100).forEach(s => {
                const interviews = schedule_data.filter(i => i.student_id === s.id)
                    .sort((a, b) => a.start_time.localeCompare(b.start_time));

                if (interviews.length === 0) return; // Optional: hide students with no interviews? No show all.

                const tr = document.createElement('tr');

                // Calculate Stats
                const appliedCount = s.applications.length;
                const shortlistedCount = s.applications.filter(a => a.status === 'shortlisted').length;
                const scheduledCount = schedule_data.filter(i => i.student_id === s.id).length;

                // create stats badge
                const statsHtml = `
                    <small style="margin-left: 10px; color: #666;">
                        <span title="Applied">üìù ${appliedCount}</span> | 
                        <span title="Shortlisted">‚úÖ ${shortlistedCount}</span> | 
                        <span title="Scheduled">üìÖ ${scheduledCount}</span>
                    </small>
                `;

                tr.innerHTML = `
                    <td>
                        <a href="#" onclick="showDetail('student', '${s.id}'); return false;"><strong>${s.name}</strong></a>
                        ${statsHtml}
                    </td>
                    <td>${s.id}</td>
                    <td>${s.email}</td>
                    <td><button style="padding:0.25rem 0.5rem; font-size:0.8rem; display:none;" class="secondary" onclick="downloadCSV('student', '${s.id}')">‚¨á CSV</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-panel').forEach(p => p.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`view-${tab}`).style.display = 'block';

            if (tab === 'admin') {
                stopLiveQueueRefresh();
                loadAdminSummary();
                loadCheckpointInfo();
                loadCompanyDefaults();
                startAdminAutoRefresh();
            } else if (tab === 'livequeue') {
                stopAdminAutoRefresh();
                startLiveQueueRefresh();
            } else if (tab === 'master-students') {
                stopAdminAutoRefresh();
                stopLiveQueueRefresh();
                renderMasterStudents();
            } else if (tab === 'master-companies') {
                stopAdminAutoRefresh();
                stopLiveQueueRefresh();
                renderMasterCompanies();
            } else if (tab === 'statistics') {
                stopAdminAutoRefresh();
                stopLiveQueueRefresh();
                loadStatistics();
            } else {
                stopAdminAutoRefresh();
                stopLiveQueueRefresh();
            }
        }

        async function loadStatistics() {
            try {
                const res = await fetch('/api/statistics');
                const d = await res.json();

                // ‚îÄ‚îÄ KPI cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                document.getElementById('stats-cards').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${d.students.total}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card" style="border-color:#16a34a;">
                        <div class="stat-number" style="color:#16a34a;">${d.students.shortlisted}</div>
                        <div class="stat-label">Shortlisted Students</div>
                    </div>
                    <div class="stat-card" style="border-color:#ea580c;">
                        <div class="stat-number" style="color:#ea580c;">${d.students.walkin_candidates}</div>
                        <div class="stat-label">Walk-in Candidates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${d.applications.total}</div>
                        <div class="stat-label">Total Applications</div>
                    </div>
                    <div class="stat-card" style="border-color:#16a34a;">
                        <div class="stat-number" style="color:#16a34a;">${d.applications.shortlisted}</div>
                        <div class="stat-label">Shortlisted Applications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${d.companies.total}</div>
                        <div class="stat-label">Companies</div>
                    </div>
                    <div class="stat-card" style="border-color:#0ea5e9;">
                        <div class="stat-number" style="color:#0ea5e9;">${d.interviews.total_scheduled}</div>
                        <div class="stat-label">Scheduled Interviews</div>
                    </div>
                    <div class="stat-card" style="border-color:#7c3aed;">
                        <div class="stat-number" style="color:#7c3aed;">${d.companies.walkin_enabled}</div>
                        <div class="stat-label">Walk-in Enabled Companies</div>
                    </div>
                `;

                // ‚îÄ‚îÄ Walk-in candidates table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const wTbody = document.querySelector('#stats-walkin-table tbody');
                wTbody.innerHTML = '';
                for (const s of (d.walkin_students || [])) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${s.name}</td><td>${s.id}</td><td>${s.email}</td><td style="text-align:center;">${s.application_count}</td>`;
                    wTbody.appendChild(tr);
                }
                if (!d.walkin_students || d.walkin_students.length === 0) {
                    wTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8;">No walk-in candidates identified</td></tr>';
                }

                // ‚îÄ‚îÄ Per-company breakdown table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const cTbody = document.querySelector('#stats-company-table tbody');
                cTbody.innerHTML = '';
                for (const c of d.per_company) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${c.company_name}</td>
                        <td style="text-align:center; color:#16a34a; font-weight:600;">${c.shortlisted}</td>
                        <td style="text-align:center; color:#94a3b8;">${c.applied}</td>
                        <td style="text-align:center;">${c.shortlisted + c.applied}</td>
                    `;
                    cTbody.appendChild(tr);
                }
            } catch(e) {
                console.error('Failed to load statistics', e);
            }
        }

        async function loadAdminSummary() {
            try {
                const res = await fetch('/api/admin-summary');
                admin_data = await res.json();
                renderAdminPanel();
            } catch (e) {
                console.error('Failed to load admin summary', e);
            }
        }

        async function loadCompanyDefaults() {
            try {
                const res = await fetch('/api/company-defaults');
                const d = await res.json();
                document.getElementById('def-avail-start').value  = d.availability_start || '09:00';
                document.getElementById('def-avail-end').value    = d.availability_end   || '17:00';
                const brk = (d.breaks && d.breaks.length) ? d.breaks[0] : {};
                document.getElementById('def-break-start').value  = brk.start || '';
                document.getElementById('def-break-end').value    = brk.end   || '';
                const dp = d.default_panel || {};
                document.getElementById('def-panel-label').value    = dp.label                || 'Panel 1 (Default)';
                document.getElementById('def-slot-duration').value  = dp.slot_duration_minutes || 30;
                document.getElementById('def-reserved').value       = dp.reserved_walkin_slots || 0;
            } catch (e) {
                console.error('Failed to load company defaults', e);
            }
        }

        async function saveCompanyDefaults() {
            const bs = document.getElementById('def-break-start').value;
            const be = document.getElementById('def-break-end').value;
            const payload = {
                availability_start: document.getElementById('def-avail-start').value,
                availability_end:   document.getElementById('def-avail-end').value,
                breaks: (bs && be) ? [{ start: bs, end: be }] : [],
                default_panel: {
                    label:                  document.getElementById('def-panel-label').value.trim() || 'Panel 1 (Default)',
                    slot_duration_minutes:  parseInt(document.getElementById('def-slot-duration').value) || 30,
                    reserved_walkin_slots:  parseInt(document.getElementById('def-reserved').value)     || 0,
                    walk_in_open: false,
                    breaks: []
                }
            };
            try {
                const res = await fetch('/api/company-defaults', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                showToast(data.status === 'error' ? `‚ùå ${data.message}` : '‚úÖ Company defaults saved');
            } catch (e) {
                showToast('‚ùå Save failed: ' + e.message);
            }
        }

        async function loadCheckpointInfo() {
            try {
                const res = await fetch('/api/checkpoint-info');
                const data = await res.json();
                const lbl = document.getElementById('checkpoint-label');
                if (lbl) {
                    if (data.last_checkpoint) {
                        const allExist = Object.values(data.backups_exist).every(v => v);
                        lbl.textContent = `Last checkpoint: ${data.last_checkpoint}${allExist ? '' : ' ‚ö† some backups missing'}`;
                    } else {
                        lbl.textContent = 'No checkpoint yet ‚Äî click üíæ Checkpoint to create one';
                    }
                }
            } catch (e) {
                console.error('Failed to load checkpoint info', e);
            }
        }

        async function doCheckpoint() {
            if (!confirm('Save a checkpoint of all data files (companies, students, schedule)?')) return;
            try {
                const res = await fetch('/api/checkpoint', { method: 'POST' });
                const data = await res.json();
                showToast(data.status === 'error' ? `‚ùå ${data.message}` : `‚úÖ ${data.message}`);
                loadCheckpointInfo();
            } catch (e) {
                showToast('‚ùå Checkpoint failed');
            }
        }

        async function doRestore() {
            if (!confirm('‚ö† Restore all data from the last checkpoint? Current data will be overwritten.')) return;
            try {
                const res = await fetch('/api/restore', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'error') {
                    showToast(`‚ùå ${data.message}`);
                } else {
                    showToast(`‚úÖ ${data.message} (from checkpoint: ${data.checkpoint_timestamp})`);
                    await loadData();  // Reload all data into the UI
                }
            } catch (e) {
                showToast('‚ùå Restore failed');
            }
        }

        // --- State for company detail view ---
        let currentCompanyDetail = null;  // full company object from /api/company/{id}

        function renderAdminPanel() {
            const grid = document.getElementById('admin-grid');
            grid.innerHTML = '';

            admin_data.forEach(c => {
                const walkinClass = c.walk_in_open ? 'walkin-open' : 'walkin-closed';
                const walkinLabel = c.walk_in_open ? 'üü¢ Walk-in Open' : 'üî¥ Walk-in Closed';
                const walkinBtnLabel = c.walk_in_open ? 'Close Walk-in' : 'Open Walk-in';

                const positionBadges = c.positions.map(p =>
                    `<span class="pos-badge">${p}</span>`
                ).join('');

                const nextInterview = c.next_interview_at
                    ? `<span>${c.next_interview_at}</span>`
                    : `<span style="color:#94a3b8;">None upcoming</span>`;

                const card = document.createElement('div');
                card.className = 'admin-card';
                card.innerHTML = `
                    <div class="admin-card-header">
                        <div>
                            <h3>${c.name}</h3>
                            <small>${c.id}</small>
                        </div>
                        <span class="walkin-badge ${walkinClass}">${walkinLabel}</span>
                    </div>

                    <div class="positions-list">${positionBadges || '<small style="color:#94a3b8;">No positions listed</small>'}</div>

                    <div class="admin-meta">
                        <div>üïê Interview Window</div>
                        <span>${c.interview_start} ‚Äì ${c.interview_end}</span>

                        <div>‚ö° Parallel Panels</div>
                        <span>${c.num_panels} panel${c.num_panels > 1 ? 's' : ''}</span>

                        <div>üìÖ Scheduled Today</div>
                        <span>${c.total_scheduled} interview${c.total_scheduled !== 1 ? 's' : ''}</span>

                        <div>‚è≠ Next Interview</div>
                        ${nextInterview}

                        <div>üóì Slots Remaining</div>
                        <span>${c.slots_remaining_today}</span>
                    </div>

                    <div class="admin-card-footer" style="justify-content:space-between;">
                        <button class="secondary" style="font-size:0.8rem; padding:0.4rem 0.8rem;"
                            onclick="event.stopPropagation(); toggleWalkin('${c.id}', this)">
                            ${walkinBtnLabel}
                        </button>
                        <button style="font-size:0.8rem; padding:0.4rem 0.8rem; background:var(--primary); color:white; border:none; border-radius:0.4rem; cursor:pointer;"
                            onclick="event.stopPropagation(); openCompanyDetail('${c.id}')">
                            ‚öô Configure
                        </button>
                    </div>
                `;
                // Whole card is also clickable
                card.addEventListener('click', () => openCompanyDetail(c.id));
                grid.appendChild(card);
            });
        }

        // ‚îÄ‚îÄ‚îÄ Company Detail View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function openCompanyDetail(companyId) {
            stopAdminAutoRefresh();
            try {
                const res = await fetch(`/api/company/${companyId}`);
                if (!res.ok) { showToast('Failed to load company'); return; }
                currentCompanyDetail = await res.json();

                document.getElementById('detail-company-name').textContent = currentCompanyDetail.name;
                document.getElementById('detail-avail-start').value = currentCompanyDetail.availability_start || '09:00';
                document.getElementById('detail-avail-end').value = currentCompanyDetail.availability_end || '17:00';
                const existingBreak = (currentCompanyDetail.breaks && currentCompanyDetail.breaks.length > 0) ? currentCompanyDetail.breaks[0] : null;
                document.getElementById('detail-break-start').value = existingBreak ? existingBreak.start : '';
                document.getElementById('detail-break-end').value = existingBreak ? existingBreak.end : '';

                renderPanels();

                document.getElementById('admin-grid').style.display = 'none';
                document.getElementById('view-company-detail').style.display = 'block';
            } catch (e) {
                showToast('Error loading company: ' + e.message);
            }
        }

        function closeCompanyDetail() {
            document.getElementById('view-company-detail').style.display = 'none';
            document.getElementById('admin-grid').style.display = '';
            currentCompanyDetail = null;
            loadAdminSummary();
            startAdminAutoRefresh();
        }

        function renderPanels() {
            const list = document.getElementById('panels-list');
            list.innerHTML = '';
            const panels = currentCompanyDetail.panels;
            if (!panels || panels.length === 0) {
                list.innerHTML = '<p style="color:#94a3b8; font-size:0.85rem;">No panels configured.</p>';
                return;
            }
            panels.forEach((p, idx) => {
                list.appendChild(renderPanelCard(p, idx));
            });
        }

        function renderPanelCard(panel, idx) {
            const company = currentCompanyDetail;
            const isLast = company.panels.length === 1;
            const walkinLabel = panel.walk_in_open ? 'üü¢ Walk-in Open' : 'üî¥ Walk-in Closed';
            const roleNames = (panel.job_role_ids || []).map(rid => {
                const r = (company.job_roles || []).find(jr => jr.id === rid);
                return r ? r.title : rid;
            }).join(', ') || 'No roles assigned';

            const card = document.createElement('div');
            card.className = 'panel-card';
            card.id = `panel-card-${panel.panel_id}`;

            // Build role checkboxes
            const roleCheckboxes = (company.job_roles || []).map(jr => {
                const checked = (panel.job_role_ids || []).includes(jr.id) ? 'checked' : '';
                return `<label class="role-checkbox-item">
                    <input type="checkbox" value="${jr.id}" ${checked} />
                    ${jr.title}
                </label>`;
            }).join('');

            card.innerHTML = `
                <div class="panel-card-header" onclick="togglePanelEditor('${panel.panel_id}')">
                    <div>
                        <div class="panel-card-title">${panel.label}</div>
                        <div class="panel-card-meta">${roleNames} ¬∑ ${panel.slot_duration_minutes} min/slot ¬∑ ${walkinLabel}</div>
                    </div>
                    <div class="panel-card-actions">
                        <span style="color:#94a3b8; font-size:0.8rem;">‚ñº Edit</span>
                        ${!isLast ? `<button style="font-size:0.75rem; padding:0.25rem 0.6rem; background:#fee2e2; color:#991b1b; border:none; border-radius:0.35rem; cursor:pointer;"
                            onclick="event.stopPropagation(); deletePanelById('${panel.panel_id}')">‚úï Delete</button>` : ''}
                    </div>
                </div>
                <div class="panel-editor" id="editor-${panel.panel_id}">
                    <div class="editor-row">
                        <label>Panel Label</label>
                        <input type="text" id="lbl-${panel.panel_id}" value="${panel.label}" style="width:200px;" />
                    </div>
                    <div class="editor-row">
                        <label>Job Roles (this panel)</label>
                        <div class="role-checkboxes" id="roles-${panel.panel_id}">${roleCheckboxes}</div>
                    </div>
                    <div class="editor-row">
                        <label>Slot Duration (min)</label>
                        <input type="number" id="dur-${panel.panel_id}" value="${panel.slot_duration_minutes}" min="10" max="120" step="5" style="width:80px;" />
                    </div>
                    <div class="editor-row">
                        <label>Reserved Walk-in Slots</label>
                        <input type="number" id="rsv-${panel.panel_id}" value="${panel.reserved_walkin_slots}" min="0" max="16" style="width:80px;" />
                    </div>
                    <div class="editor-row">
                        <label>Walk-in Open</label>
                        <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                            <input type="checkbox" id="wi-${panel.panel_id}" ${panel.walk_in_open ? 'checked' : ''} />
                            Enable walk-in for this panel
                        </label>
                    </div>
                    <div class="editor-row" style="margin-top:0.5rem; padding-top:0.5rem; border-top:1px dashed #e2e8f0;">
                         <label title="Overrides company break for this panel. Leave empty to inherit company-level break. Note: only one break window per panel is supported via this UI.">Lunch Break (Override)</label>
                         <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
                             <input type="time" id="brk-start-${panel.panel_id}" value="${(panel.breaks && panel.breaks.length) ? panel.breaks[0].start : ''}" title="Break start" style="width:110px;" />
                             <span style="color:#94a3b8; font-size:0.8rem;">to</span>
                             <input type="time" id="brk-end-${panel.panel_id}" value="${(panel.breaks && panel.breaks.length) ? panel.breaks[0].end : ''}" title="Break end" style="width:110px;" />
                             <span style="color:#94a3b8; font-size:0.72rem; cursor:help;" title="Empty = inherit company break. To allow this panel to work during company break, configure per-panel breaks on all panels and leave company break empty.">‚ÑπÔ∏è</span>
                         </div>
                    </div>
                    <div class="editor-actions">
                        <button class="secondary" style="font-size:0.82rem;" onclick="togglePanelEditor('${panel.panel_id}')">Cancel</button>
                        <button style="font-size:0.82rem;" onclick="saveSinglePanel('${panel.panel_id}')">üíæ Save Panel</button>
                    </div>
                </div>
            `;
            return card;
        }

        function togglePanelEditor(panelId) {
            const editor = document.getElementById(`editor-${panelId}`);
            if (editor) editor.classList.toggle('open');
        }

        function addPanel() {
            const company = currentCompanyDetail;
            const newIdx = company.panels.length + 1;
            const newPanel = {
                panel_id: `${company.id}-P${newIdx}-${Date.now()}`,
                label: `Panel ${newIdx}`,
                job_role_ids: (company.job_roles || []).map(r => r.id),  // default: all roles
                slot_duration_minutes: 30,
                walk_in_open: false,
                reserved_walkin_slots: 0
            };
            company.panels.push(newPanel);
            renderPanels();
            // Auto-open the new panel editor
            setTimeout(() => togglePanelEditor(newPanel.panel_id), 50);
        }

        function deletePanelById(panelId) {
            if (currentCompanyDetail.panels.length <= 1) {
                showToast('Cannot delete the last panel.');
                return;
            }
            if (!confirm('Delete this panel?')) return;
            currentCompanyDetail.panels = currentCompanyDetail.panels.filter(p => p.panel_id !== panelId);
            savePanels();
        }

        function saveSinglePanel(panelId) {
            const panel = currentCompanyDetail.panels.find(p => p.panel_id === panelId);
            if (!panel) return;

            panel.label = document.getElementById(`lbl-${panelId}`).value.trim() || panel.label;
            panel.slot_duration_minutes = parseInt(document.getElementById(`dur-${panelId}`).value) || 30;
            panel.reserved_walkin_slots = parseInt(document.getElementById(`rsv-${panelId}`).value) || 0;
            panel.walk_in_open = document.getElementById(`wi-${panelId}`).checked;

            // Collect checked role IDs
            const roleContainer = document.getElementById(`roles-${panelId}`);
            panel.job_role_ids = Array.from(roleContainer.querySelectorAll('input[type=checkbox]:checked'))
                .map(cb => cb.value);

            // Collect Break
            const bs = document.getElementById(`brk-start-${panelId}`).value;
            const be = document.getElementById(`brk-end-${panelId}`).value;
            panel.breaks = (bs && be) ? [{ start: bs, end: be }] : [];

            savePanels();
        }

        async function savePanels() {
            const company = currentCompanyDetail;
            try {
                const res = await fetch(`/api/company/${company.id}/panels`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(company.panels)
                });
                const data = await res.json();
                if (data.status === 'error') {
                    showToast('Error: ' + data.message);
                } else {
                    showToast('‚úÖ Panels saved');
                    renderPanels();
                }
            } catch (e) {
                showToast('Save failed: ' + e.message);
            }
        }

        async function saveCompanySettings() {
            const company = currentCompanyDetail;
            const start = document.getElementById('detail-avail-start').value;
            const end = document.getElementById('detail-avail-end').value;
            const brkStart = document.getElementById('detail-break-start').value;
            const brkEnd = document.getElementById('detail-break-end').value;
            const breaks = (brkStart && brkEnd) ? [{ start: brkStart, end: brkEnd }] : [];
            try {
                const res = await fetch(`/api/company/${company.id}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ availability_start: start, availability_end: end, breaks })
                });
                const data = await res.json();
                if (data.status === 'error') {
                    showToast('Error: ' + data.message);
                } else {
                    currentCompanyDetail.availability_start = start;
                    currentCompanyDetail.availability_end = end;
                    currentCompanyDetail.breaks = breaks;
                    showToast('‚úÖ Settings saved');
                }
            } catch (e) {
                showToast('Save failed: ' + e.message);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _toastTimer = null;
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            if (_toastTimer) clearTimeout(_toastTimer);
            _toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
        }

        async function toggleWalkin(companyId, btn) {
            btn.disabled = true;
            try {
                const res = await fetch(`/api/toggle-walkin/${companyId}`, { method: 'POST' });
                const data = await res.json();
                if (data.status !== 'error') {
                    await loadAdminSummary();
                } else {
                    alert('Failed: ' + data.message);
                }
            } catch (e) {
                alert('Request failed');
            } finally {
                btn.disabled = false;
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        init();
    </script>
</body>

</html>
